# AI团队系统（多Agent + RAG知识库 + 权限管理 + 断点续传）

## 项目简介
本系统是面向企业级AI团队的多智能体（Multi-Agent）协作平台，支持专业角色分工、MCP协议工具集成、本地RAG知识库检索、企业级RBAC+ABAC权限管理、断点续传功能，助力AI项目高效落地。

---

## 主要功能
- **多Agent协作**：支持项目总监、产品经理、技术总监、前后端、算法、UI、数据分析、测试、DevOps、文员等11大专业角色，流程全覆盖。
- **MCP协议工具**：统一MCP协议接口，支持文件/代码/部署/自动化等标准化操作。
- **本地RAG知识库**：支持Chroma向量库+BM25关键词混合检索，知识块可按角色/文件分权。
- **企业级权限管理**：RBAC+ABAC混合模型，支持用户/角色/资源/操作多维权限，个人特批优先。
- **断点续传功能**：支持项目进度保存、阶段恢复、进度查询，避免重复工作。
- **一键知识库构建**：自动分块、嵌入、索引，支持txt/md/yaml等多格式批量导入。
- **可扩展API**：支持集成API服务、管理后台、前端等。
- **需求驱动全自动部署**：只需下达需求，AI团队自动完成代码生成、文档、测试、Docker镜像构建与容器部署，无需手动输入任何参数。
- **需求ID唯一+自动归档清理**：每个需求有唯一ID（如项目名），每次执行同名需求时，系统会自动归档并清理旧产出、日志、Docker容器，保证每次都是全新环境。所有需求ID与内容的映射关系记录在`projects/project_index.json`，支持历史追溯和环境隔离。

---

## 目录结构
```
ai_team_system/
├── src/                  # 核心代码
│   ├── main.py           # Typer命令行入口（已集成全自动部署+需求ID唯一+自动归档清理+断点续传）
│   ├── crew.py           # 多Agent团队与流程（含断点续传功能）
│   ├── crew_tools.py     # MCP工具适配
│   ├── rag_api.py        # RAG检索+权限API
│   ├── permission_manager.py # 权限管理
│   └── ingest_knowledge_base.py # 知识库向量化/索引
├── knowledge_base/       # 角色知识库（分角色/分文件夹）
├── vector_db/            # 本地Chroma向量库/BM25索引
├── config/               # 角色、模型、团队配置
├── projects/             # 项目输出及project_index.json
├── archive/              # 历史归档产出
├── logs/                 # 项目执行日志
├── requirements.txt      # 依赖
└── README.md             # 项目说明
```

---

## 环境变量与自动加载

本项目所有敏感配置（如OPENAI_API_KEY）均存放于根目录的.env文件，例如：
```
OPENAI_API_BASE=https://api.openai-proxy.org/v1
OPENAI_API_KEY=sk-xxxxxx
```
- **自动加载机制**：主程序已集成python-dotenv，运行时会自动加载.env，无需手动source。
- **常见问题排查**：如遇到LLM相关API报错，请优先检查.env文件内容和路径，确保key有效。
- **无需手动source .env**：直接运行python -m src.main ... 即可，环境变量会自动生效。

---

## 快速上手

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 构建知识库索引
> 支持knowledge_base/下txt、md、yaml等批量导入，自动分块、嵌入、索引
```bash
python src/ingest_knowledge_base.py
```

### 3. 启动AI团队项目（全自动部署，无需参数！）
```bash
python -m src.main --project-name "员工请假小程序" --requirements "开发一个员工请假小程序，支持多级审批、权限管理、请假记录查询、移动端适配、RAG知识库、MCP协议集成、自动化部署。"
```
- 系统会自动完成需求分析、代码/文档/测试/部署脚本生成、Docker镜像构建与容器部署。
- 你无需手动输入任何部署参数，服务自动上线。
- 每次执行同名需求时，系统会自动归档并清理旧产出、日志、Docker容器，保证环境唯一。
- 所有需求ID与内容的映射关系可在`projects/project_index.json`查阅。

### 3.1 断点续传功能
系统支持断点续传，可以从中断的地方继续执行：

```bash
# 查看项目进度
python -m src.main --project-name "员工请假系统" --show-progress

# 从指定阶段继续执行
python -m src.main --project-name "员工请假系统" --requirements "开发一个员工请假系统..." --resume-from "frontend_code"

# 重置项目进度，重新开始
python -m src.main --project-name "员工请假系统" --reset-progress
```

**可用阶段**：
- `requirement_analysis` - 需求分析
- `technical_design` - 技术设计  
- `ui_design` - UI设计
- `frontend_development` - 前端开发讨论
- `frontend_code` - 前端代码生成
- `backend_development` - 后端开发讨论
- `backend_code` - 后端代码生成
- `data_analysis` - 数据分析
- `testing` - 测试
- `deployment` - 部署
- `documentation` - 文档
- `acceptance` - 验收
- `auto_execution` - 自动执行

**断点续传优势**：
- 支持长时间项目的分段执行
- 避免重复执行已完成的工作
- 可以针对特定阶段进行调试和优化
- 进度状态自动保存，支持多项目并行

### 4. RAG知识库检索（带权限）
```python
from src.rag_api import rag_search
# user_id, role, query, top_k
print(rag_search("u001", "boss", "项目管理最佳实践"))
```

---

## 权限管理说明
- 权限规则存储于config/permissions.json
- 支持用户/角色/资源/操作多维度，个人特批优先
- 可通过src/permission_manager.py增删查权限

---

## MCP协议工具说明
- 统一MCP协议接口，支持文件读写、代码生成、执行、Docker部署等
- 详见src/crew_tools.py、mcp_server.py

---

## 依赖环境
- Python 3.9+
- 主要依赖：crewai, typer, rich, pyyaml, openai, chromadb, sentence-transformers, scikit-learn, docker

---

## 典型场景
- 企业AI团队协作、知识管理、权限管控、自动化交付
- AI项目全流程自动化、专业分工、知识安全
- 长时间项目的分段执行和断点续传

---

## 贡献与反馈
欢迎提交Issue/PR，或联系AI团队共建更强大的智能协作平台！

---

## 多角色多轮对话与共识机制

- 需求分析、技术设计、前端开发、后端开发、验收等关键阶段，均支持多角色多轮对话，自动产出共识文档和对话日志。
- 每个阶段可灵活配置参与角色、对话轮数、最终汇总角色，产出更真实、可复核。
- 所有对话过程、共识产出自动归档于产出目录，便于溯源和复盘。
- 主流程上下文链路自动传递，确保各阶段产出高度协作和一致。

### 完整开发流程

系统采用"讨论先行，代码后行"的协作模式：

1. **需求分析阶段**：项目总监 + 产品经理 + 技术总监多轮讨论
   - 深入分析用户需求、功能需求、非功能性需求
   - 确定项目范围、风险评估和应对策略
   - 产出需求分析共识文档

2. **技术设计阶段**：技术总监 + 产品经理 + 前端开发 + 后端开发多轮讨论
   - 系统架构设计和技术选型
   - 数据库设计和API接口规范
   - 安全架构和性能优化策略
   - 产出技术设计共识文档

3. **UI设计阶段**：UI设计师单Agent执行
   - 基于需求和技术方案设计用户界面
   - 交互设计和视觉设计规范
   - 响应式设计和设计系统构建
   - 产出UI设计文档

4. **前端开发阶段**：
   - **讨论阶段**：前端开发 + UI设计师 + 技术总监多轮讨论
     - 确定前端技术栈和架构
     - 组件设计和状态管理方案
     - 性能优化和用户体验策略
   - **代码生成阶段**：前端开发单Agent执行
     - 基于讨论结果生成完整前端代码
     - 包含组件库、工具函数、测试用例
     - 自动提取代码块并写入项目目录

5. **后端开发阶段**：
   - **讨论阶段**：后端开发 + 技术总监 + 产品经理多轮讨论
     - 确定后端技术栈和架构
     - API设计和数据库操作方案
     - 安全性和性能优化策略
   - **代码生成阶段**：后端开发单Agent执行
     - 基于讨论结果生成完整后端代码
     - 包含API接口、数据库脚本、业务逻辑
     - 自动提取代码块并写入项目目录

6. **其他阶段**：数据分析、测试、部署、文档、验收
   - 各专业角色基于前期成果进行专项工作
   - 自动生成相应的报告和配置文档

7. **自动执行与修正**：
   - 系统自动检测并执行生成的代码文件
   - 支持Python、Shell、npm、pytest、Docker等多种执行类型
   - 多Agent协作修正执行中的问题
   - 确保代码能够正常运行和部署

---

## 产出目录结构示例

每次下达新需求，系统会自动在 `projects/{需求ID}/` 下生成独立产出目录，所有代码、文档、日志、Dockerfile等均归档于此。例如：

```
projects/员工请假小程序/
  ├── progress.json              # 断点续传进度文件
  ├── 需求分析_共识文档.md
  ├── 需求分析_discussion_log.txt
  ├── 技术设计_共识文档.md
  ├── 技术设计_discussion_log.txt
  ├── 前端开发_共识文档.md
  ├── 前端开发_discussion_log.txt
  ├── 后端开发_共识文档.md
  ├── 后端开发_discussion_log.txt
  ├── 验收_共识文档.md
  ├── 验收_discussion_log.txt
  ├── UI设计.md
  ├── 数据分析报告.md
  ├── 测试报告.md
  ├── 部署文档.md
  ├── 项目文档.md
  ├── Dockerfile
  └── llm_log.txt
```
- 所有多角色对话日志和共识文档均自动归档，便于溯源、复盘和团队复核。
- 自动部署、归档、清理等操作均以需求ID为唯一标识。
- `progress.json`文件记录每个阶段的执行状态，支持断点续传。

---

## 常见问题排查

- 如遇到"产出目录/llm_log.txt/Dockerfile缺失"，请优先检查：
  1. `.env` 文件内容和路径，确保API Key有效。
  2. 控制台是否有LLM调用、产出落盘、自动部署等报错。
  3. `projects/{需求ID}/` 目录是否被误删或权限不足。
- 如需溯源LLM对话、调试Agent行为，可直接查阅 `llm_log.txt`。
- 如需查看项目进度或从指定阶段继续，使用 `--show-progress` 和 `--resume-from` 参数。
- **如遇到 `No module named 'src'` 或 `can't open file 'src/main.py'` 错误：**
  - 请确保你已进入 `ai_team_system` 目录后再运行命令：
    ```bash
    cd ai_team_system
    python src/main.py --project-name "员工请假系统" --requirements "..."
    ```
  - 如果在项目根目录直接运行 `python -m src.main ...` 会报错，因为此时 `src` 不是包的上级目录。
  - 一定要在 `ai_team_system` 目录下运行 `python src/main.py ...`。

---

## 🏆 AI团队系统业务验收标准

### 业务需求（唯一测试用例）

> **开发一个员工请假小程序**
>
> - 支持员工在线提交请假申请
> - 支持主管/HR多级审批
> - 支持请假记录查询、统计
> - 支持移动端适配
> - 权限管理、自动化部署、RAG知识库问答、MCP协议集成

### 测试方法

1. 运行如下命令，给AI团队下达需求：
   ```bash
   python -m src.main --project-name "员工请假小程序" --requirements "开发一个员工请假小程序，支持多级审批、权限管理、请假记录查询、移动端适配、RAG知识库、MCP协议集成、自动化部署。"
   ```
2. 检查AI团队产出：
   - 前后端代码、数据库设计、API文档、测试用例、部署脚本、权限配置等，均在 `projects/员工请假小程序/` 下。
   - 所有LLM输入输出日志可在 `llm_log.txt` 查阅。
   - 自动部署产物、归档、日志等均与需求ID强绑定。
   - 进度文件 `progress.json` 记录各阶段执行状态。
3. 实际运行/部署/访问小程序，验证功能是否可用。

### 验收标准

- 只有当"员工请假小程序"能真实跑起来、可用，且所有产出、日志、部署等均可在独立目录和llm_log.txt中查验，才算AI团队系统通过测试。

---

## 📚 角色专属文档与知识库联动

### 机制说明
- 每个角色（产品、开发、测试、老板等）在项目执行过程中，都会自动生成/维护自己的专属文档。
- 这些文档不仅为本角色自用，更是为团队其他成员服务（如测试文档给开发看，需求文档给开发/测试看）。
- 所有文档内容会自动同步到本地RAG知识库，支持通过MCP协议/自然语言检索，快速获取所需信息。
- 日志系统实时记录多角色对话、任务分配、bug反馈等，便于追溯和进度查询。

### 推荐目录结构
```
docs/
├── 产品需求.md         # 产品经理写，开发/测试/老板看
├── 开发说明.md         # 开发写，测试/产品/老板看
├── 接口文档.md         # 开发写，测试/产品/老板看
├── 测试用例.md         # 测试写，开发/产品/老板看
├── bug列表.md          # 测试写，开发/产品/老板看
├── 决策纪要.md         # 老板/管理层写，全员看
├── 进度报告.md         # 各角色写，全员看
logs/
└── conversation.log    # 多角色对话与任务分配实时日志
knowledge_base/
└── ...                 # 自动同步各文档内容，支持RAG检索
```

### 典型场景
- 开发查需求：查阅`产品需求.md`或用MCP问"本次要开发什么？"
- 测试查接口：查阅`接口文档.md`或用MCP问"请假API怎么用？"
- 老板查进度：查阅`进度报告.md`或用MCP问"当前进度如何？"
- 开发查bug：查阅`bug列表.md`或用MCP问"有哪些bug还没修？"

### 价值
- 保证每个角色都能随时查阅、对齐目标，避免信息丢失和沟通障碍。
- 支持团队成员和外部人员通过自然语言检索所有知识和文档。
- 日志与文档联动，便于进度追踪、问题定位和责任追溯。

---

## LLM输入输出日志与溯源

- 每次AI团队成员（Agent）调用大模型（LLM）时，系统会自动将如下内容详细打印到控制台，并写入产出目录llm_log.txt：
  - 角色（如"项目总监"、"产品经理"等）
  - 任务名
  - LLM输入Prompt
  - LLM输出Result
  - 上下文（如有）
- 多角色多轮对话过程自动写入 `*discussion_log.txt`，共识产出写入 `*_共识文档.md`，便于溯源、复盘和团队共识。
- 日志文件路径：`projects/{需求ID}/llm_log.txt` 及各阶段对话日志。
- 控制台输出示例：
  ```
  ================ LLM调用日志 ================
  [2024-06-23 12:00:00] 角色: 项目总监 任务: requirement_analysis
  【输入Prompt】
  ...
  【输出Result】
  ...
  ============================================
  ```
- 便于溯源、调试和团队协作。

---

## 自动产出落盘机制与类型安全说明

- **自动产出落盘机制**：每个Agent任务执行后，LLM输出内容会自动写入 `projects/{需求ID}/` 下的对应文件（如 需求分析.md、技术设计.md、UI设计.md、Dockerfile 等），并自动解析结构化产出（如代码块、Dockerfile）递归写入子目录和文件，所有产出均为真实文件，自动部署不再因缺文件而失败。
- **类型安全注入**：所有Agent的 `project_id` 和 `project_dir` 全程为str类型，杜绝None参与路径拼接，保证产出机制健壮。
- **入口参数强绑定**：务必通过 `--project-name` 和 `--requirements` 传递真实业务需求，系统不会再有任何默认业务内容，所有产出、日志、归档、部署等全链路都以需求ID为唯一锚点。
- **断点续传机制**：系统自动保存每个阶段的执行状态到 `progress.json`，支持从任意阶段继续执行，避免重复工作。
- **代码健壮性与可维护性**：注释和类型安全机制已优化，便于团队协作和扩展。